<!DOCTYPE html>
<html>
  <head>           
      <title>P-07</title> 
      
      <meta charset="utf-8">              
      <meta name="description" content="A cool thing made with Glitch"> 
      <meta http-equiv="X-UA-Compatible" content="IE=edge"> 
      <meta name="viewport" content="width=device-width, initial-scale=1">      


    
  <style id="jsbin-css">
* {
  box-sizing:    border-box;
  font:          18px "Open Sans", sans-serif;
}

form input {
  border:        1px solid grey;
  margin-bottom: 10px;
  padding:       0px 2px 0px 2px;
}

#mask{
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.7);
    visibility: hidden;
    z-index: 98;  
}

#popupbox {
  margin: 50px 50px; 
  padding: 10px 10px 5px 10px;
  position: absolute;
  background: LightGrey;
  border: solid White 1px;
  z-index: 99;
  visibility: hidden;
}

.ord {
  background:    #f3f3f3;
  border:        1px solid black;
  border-radius: 5px;
  box-shadow:    2px 2px grey;
  padding:       10px 15px 7px;
  color:         black;
  display:       inline-block;
  text-align:    center;
  text-shadow:   none;
}
.ord:hover {
  background-color: white
}
.ord:active {
  box-shadow: none;
}


.mnu {

  background:    #000000; 
  border:        2px solid #777777;
  border-radius: 0px;
  padding:       5px 10px; 
  color:         #ffffff; 
  display:       inline-block; 
  text-align:    center; 
  text-shadow:   none; 
  box-shadow:    none;
}
.mnu:hover {
  background-color: grey;
}
.mnu:active {
  color: black;
  background-color: lightgrey;
}


table.minimalistBlack {
  width: 100%;
  border-collapse: collapse;
}
table.minimalistBlack th{
  background:  lightgrey; 
  padding:     2px 10px 2px 10px; 
  border:      1px solid grey;
  
  font-size:   15px;
  /*font-weight: bold;*/
  text-align:  center;
}
table.minimalistBlack td {
  padding:     1px 10px 1px 10px;
  border:      1px solid lightgrey;   
}

</style>
    <script src="cordova.js"></script>

    <!-- jQuery and JQ Mobile -->
    <script type="text/javascript" src="js/jquery-1.12.4.min.js"></script>
    
      <script> 
        window.onbeforeunload= function() { return "Reload database?"; } 
        var audClick= new Audio('https://raw.githubusercontent.com/pokerica/pokerica.github.io/data/audClick.wav'); 
        audClick.load(); 
 
      </script>
    
</head>
  
  <body style="background-color:#555555; width:500px; margin: 0 auto"> 
    
    <div id="mask"></div>
    <div id="popupbox">
      <form id="logIn" onsubmit="return false" > 
        <input id="pasIn" placeholder="PASSWORD" type="password" size="9" />
        <input class="ord" type="submit" value="Login" />
      </form> 
    </div>

    <div id="mnu" style="background-color:black; color:white; padding:5px 5px" align="right">           
            <input type="button" class="mnu" id="ttl" style="float:left;" value="***"/>
            <button class="mnu" id="mnu1">Edit</button> 
            <button class="mnu" id="mnu2">Resize</button> 
            <button class="mnu" id="mnu3">Exit</button>              
    </div>
  
    <div id="bdy" style="background-color:white; padding:0px 10px 10px 10px"> 
      
      <form id="frmInput" onsubmit="return false" 
            style="width:480px; padding:10px 10px 0px 5px; background-color:#ffffff"> 

         <button class="ord" type="submit" style="float:right; margin-top:10pt">Submit</button> 

         <input id="in0" type="number" placeholder="ID" style="text-align:right; width:2em" autocomplete="off"/><br> 
         <input id="in1" type="text" placeholder="NAME" size="12" autocomplete="off"/> 
         &nbsp;<input id="in2" type="number" placeholder="GAMES" style="text-align:right; width:4.5em" autocomplete="off"/> 
         &nbsp;<input id="in3" type="number" placeholder="WINS" style="text-align:right; width:4.5em" autocomplete="off"/> 
      </form> 
       
      <table class="minimalistBlack">
      <thead><tr><th>ID</th><th style="text-align:center">NAME</th><th>GAMES</th>
                 <th>WINS</th><th style="text-align:center">W/G</th></tr></thead>
      <tbody id="ptb" align="right"></tbody> 
      </table> 
      
      <br>
      &nbsp;<button class="ord" id="rsBut">Reset</button> 
      &nbsp; <button class="ord" id="svBut">Save</button> 
      &nbsp; <button class="ord" id="psBut">Persistent Storage</button>      
      <br><br>  
      <iframe id="dbFrame" width="480px" height="50px" style="border:none">
      <!--iframe id="dbFrame" src="db.txt" width="480px" height="50px" style="border:none"-->
        <p>Your browser does not support iframes.</p>
      </iframe>     
    
      <input type="file"><script> var fileUp= document.getElementById('fIn').files[0]; </script> 
      <input type="file" name="db.txt"/>
      <a href="db.txt" download> <button class="ord">Download</button></a> 

    </div>


  <script id="jsbin-javascript">
// client.js
// run by the browser each time page is loaded
$(document).ready(
  function() {

    $.ajaxSetup({ async: true }); 

    var filesha="#init";
    var dbPas = "*pasInit";
    var prH = "1px 10px 1px 10px";
    var tPl = [ ["0", "declaration-init", "0", "0", "0"] ];
    var dbUrl = "https://api.github.com/repos/pokerica/pokerica.github.io/";
   
    var cshVer = 0;
    function updateCashe() {
/*
      window.UpUp.start({
        'cache-version': "v" + (cshVer++),
        'content-url': 'index.html',
        'assets': ['client.js', 'style.css', 'db.txt']
      });
*/     
      
    }

    function reFresh() {

      var ttxt = "Party Mix";
      if (!navigator.onLine)
        ttxt = "Party Mix --- OFFLINE"; 
      document.getElementById("ttl").value = ttxt;
      
      tPl.sort(function(a, b) {
        return b[4] - a[4]
      });

      $("#ptb").empty();
      //tPl.forEach(function(col) {
      for(var i= 0; i < 100; i++) {

        $('#ptb').append('<tr><td style="padding:' + prH + '">' + tPl[i][0] + '</td><td align="left">' + tPl[i][1] +
          '</td><td>' + tPl[i][2] + '</td><td>' + tPl[i][3] + '</td><td>' + tPl[i][4] + "% " + '</td></tr>'); 
      }
      
      //});    
    }


    function loadDB() {      

      $.ajax({
        url: dbUrl + "git/blobs/" + filesha, 
      //dataType: 'json',
        type: 'GET',
        beforeSend: function(xhr) { 
           xhr.setRequestHeader("Authorization", "Basic " + btoa("pokerica" + ":" + dbPas)); 
        },

        error: function(xhr, textStatus, error) {
          alert("err1: " + xhr.statusText + "\nerr2: " + textStatus + "\nerr3: " + error);
        }
      }).done(function(response, st, x) {
        //alert("proso: " + atob(response.data.content));        
        //alert("proso-json :" + atob(response.content));      

        //alert("loadDB-done: " + x.getAllResponseHeaders());

        var data = atob(response.content).split(',');
        //alert(data)
        
        tPl.length = 0;
        for (var i = 0; i < data.length / 4; i++) {
          if (Number(data[i * 4]) > 0)
            tPl[i] = [data[i * 4 + 0], data[i * 4 + 1], data[i * 4 + 2],
              data[i * 4 + 3], (100 * data[i * 4 + 3] / data[i * 4 + 2]).toFixed(2)
            ];
        }


        //frames['dbFrame'].contentWindow.document.body.textContent = tPl;
        reFresh();
      });      
    }

    function getSha() {

          var xhr = new XMLHttpRequest();
          var url = dbUrl + "git/trees/data";           

          if ("withCredentials" in xhr)
            xhr.open('GET', url, false); //true: async
          else {
            xhr = null;
            throw new Error('CORS not supported');
          }

          xhr.onerror = function() {
            alert('COARS error!');
          }

          xhr.onloadend = function() {

            //alert("getShA-loadend: "+xhr.getAllResponseHeaders());

            var str = xhr.responseText;

            var pos1 = str.indexOf('db.txt');
            pos1 = str.indexOf('"sha": "', pos1);
            var pos2 = str.indexOf('",', pos1);
            filesha = str.substring(pos1 + 8, pos2);

            loadDB();
            updateCashe();
          }

          xhr.setRequestHeader("Authorization", "Basic " + btoa("pokerica" + ":" + dbPas)); 
          xhr.withCredentials = false;
          xhr.send();
    }



//*** action starts here
    
    //*** modal popup login dialog          
    document.getElementById('mask').style.visibility = "visible";
    document.getElementById('popupbox').style.visibility = "visible";
    $('input#lg0').focus(); 


    $("#logIn").submit(
      function(event) {
      
        dbPas = $('input#pasIn').val(); 
        document.getElementById('mask').style.visibility = "hidden";
        document.getElementById('popupbox').style.visibility = "hidden"; 

        getSha();

      });


    $("#svBut").click(
      function() {
        
        var upData = [ ["0", "upload-data", "0", "0"] ];
 
        tPl.forEach(function(col) {
          upData.push(col[0], col[1], col[2], col[3]);
        });

        if (navigator.onLine) {     

            //***************** S A V E  D B ****************************************            
            var filemessage = "datttteee";
            var filecontent = upData;
            var basecontent = btoa(filecontent);   
            var filedata = '{"message":"'+ filemessage +'","content":"'+ basecontent 
                             +'", "branch":"'+ "data" +'", "sha":"' + filesha + '"}'; 
 
            $.ajax({
              url: dbUrl + "contents/db.txt", 
              type: 'PUT',
              beforeSend: function(xhr) {
                //xhr.setRequestHeader("Authorization", "token 1fa49d9ba6xxxxxxxx462b3e9d690073c99");
                xhr.setRequestHeader("Authorization", "Basic " + btoa("pokerica" + ":" + dbPas)); 
              },
              
              data: filedata,
              
              error: 
              function(e) { alert("Error: \n"+ JSON.stringify(e)); }
                   
            }).done(function(response, st, x) {
              //alert("proso: " + response.toString());

              alert("saveDB-done: " + x.getAllResponseHeaders());

              reFresh();
              updateCashe();

              document.getElementById("dbFrame").contentWindow.document.body.textContent = upData;

              alert("Database saved! cache.v" + cshVer);
            }); 
            //********************************************************* 
 
        } else {

          reFresh();
          alert("No connection to server, saved to memory!");
          frames['dbFrame'].contentWindow.document.body.textContent = upData;
        }

      });



    $("#frmInput").submit(
      function(event) {
        //event.preventDefault(); 
        var col0 = $('input#in0').val();
        var col1 = $('input#in1').val();
        var col2 = $('input#in2').val();
        var col3 = $('input#in3').val();
        var col4 = (100 * col3 / col2).toFixed(2);

        tPl.push([col0, col1, col2, col3, col4]);

        reFresh();
        $('input#in0').val('');
        $('input#in1').val('');
        $('input#in2').val('');
        $('input#in3').val('');

        $('input#in0').focus();
      });

    $("#rsBut").click(
      function() {
        tPl = [
          ["0", "reset-init", "0", "0", "0"]
        ];
        reFresh();
      });

    $("#psBut").click(
      function() {

        if (!Notification)
          alert('Desktop notifications not available in your browser. Try Chromium.');
        else
          Notification.requestPermission();

        if (navigator.storage) {
          if (navigator.storage.persist) {
            navigator.storage.persist().then(
              granted => {
                if (granted)
                  alert("Persistence granted!");
                else
                  alert("Persistence denied!");
              });
          } else
            alert("Persistent storage not available!");
        } else
          alert("Offline storage not available!");
      });


    $(".ord").click(
      function() {
        window.audClick.currentTime = 0;
        window.audClick.play();
      });

    $(".mnu").click(
      function() {
        window.audClick.currentTime = 0;
        window.audClick.play();
      });


    $("#mnu1").click(
      function() {
        document.getElementById('mask').style.visibility = "visible";
        document.getElementById('popupbox').style.visibility = "visible";
        $('input#lg0').focus();
      });

    $("#mnu2").click(
      function() { 
        
        if (prH != "1px 10px 1px 10px")
          prH = "1px 10px 1px 10px";
        else
          prH = "10px 10px 10px 10px";

        reFresh();
      });

    $("#mnu3").click(
      function() {

        //loadDB();
        //reFresh();       
        
        //alert();

        var num= 10000;
        tPl.length = 0;
        for (var i = 0; i < num; i++) {

          var name= (Math.random()+Math.random()).toString(36).replace(/[^a-zA-Z]+/g, '').substr(0, 9);

            tPl[i] = [i+1, name.charAt(0).toUpperCase() + name.slice(1),
                        num+100, i+2, (100 * (i+2)/(num+100)).toFixed(2)];
        } 

        reFresh();      

      });      


  }); //doc.ready()

/*  
   //var dburl= "https://lovely-depositooo.glitch.me/db.txt"; 
   //var dburl= "https://pokerica.github.io/db.txt";
   //var dburl= "https://github.com/pokerica/pokerica.github.io/releases/download/v0.2/db.txt";
   var dburl= "https://api.github.com/repos/pokerica/pokerica.github.io/releases/assets/5729447"; 

   fetch(dburl, {
        mode: "cors",
        redirect: "follow",
        headers: {      
          "Authorization": "Basic " + btoa("pokerica" + ":" + "qweRT123"), 
          
         // "Accept": "application/octet-stream"
        }                            
     }).then(
     function(response) { 
       alert("aaaa: " + response.redirected);
       var headStr= "Type: "+ response.type +" \nStatus: "
                     + response.status +" \nUrl: "+ response.url +" \n"; 
       
    //  if(response.ok) { 
         
         response.headers.forEach( 
           function(value, name) {              
             headStr+= " \n"+ name +": "+ value; 
           });        
         
         alert(headStr); 
         return response.text(); 
       //}
       
       //alert("MyError: " + response.status);
      // return;
       
     },
     
     function(error) { 
       alert(error);
     
     }).then(function(bt) { alert("Body: \n" + bt); });
*/
      
      
/* handle offline?

  $("#dbFrame").on('load',
  function() { 
      var dbf= this.contentWindow.document.body;
    
      dbf.style.fontSize= '12px';     
      dbf.style.lineHeight= '14px';
      dbf.style.color= 'white';
      dbf.style.backgroundColor= 'grey';
    
      var data= dbf.textContent.split(','); 

      tPl.length= 0;     
      for(var i= 0;i < data.length/4;i++) {
        
        if(Number(data[i*4]) > 0) 
          tPl[i]= [data[i*4 +0], data[i*4 +1], data[i*4 +2], 
                   data[i*4 +3], (100 * data[i*4 +3]/data[i*4 +2]).toFixed(2)];         
      }       
  }); 

*/

</script>
</body>
</html>

